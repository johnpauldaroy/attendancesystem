rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    // Fetch user data from the 'users' collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check for specific roles
    function hasRole(role) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        getUserData().role == role;
    }

    function isSuperAdmin() {
      return hasRole('SUPER_ADMIN');
    }

    function isBranchAdmin() {
      return hasRole('BRANCH_ADMIN');
    }

    function isApprover() {
      return hasRole('APPROVER');
    }

    function isStaff() {
      return hasRole('STAFF');
    }

    function isAdminOrApprover() {
      return isSuperAdmin() || isBranchAdmin() || isApprover();
    }

    function isStaffOrAbove() {
      return isAuthenticated();
    }

    function sameBranch(value) {
      return isSuperAdmin() ||
        (value != null && getUserData().branch_id != null &&
          string(value) == string(getUserData().branch_id));
    }

    function branchFrom(req, res) {
      return (req != null && req.origin_branch_id != null)
        ? req.origin_branch_id
        : (res != null ? res.origin_branch_id : null);
    }

    // --- Collections ---

    // Users Collection
    match /users/{userId} {
      // Users can read/write their own data
      // Super Admins can manage all users
      allow read: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin() || isBranchAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
    }

    // Members Collection
    match /members/{memberId} {
      // READ:
      allow read: if isAuthenticated();
      
      // CREATE / UPDATE:
      allow write: if request.resource != null &&
        (
          isSuperAdmin() ||
          sameBranch(branchFrom(request.resource.data, resource != null ? resource.data : null))
        );

      // DELETE:
      allow delete: if isSuperAdmin() || sameBranch(resource.data.origin_branch_id);
    }

    // Attendance Collection (one doc per member per calendar day)
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        isSuperAdmin() || 
        sameBranch(resource.data.origin_branch_id) ||
        (getUserData().branch_id != null && resource.data.visited_branch_id == getUserData().branch_id)
      );

      allow create: if isStaffOrAbove() &&
        request.resource.data.keys().hasAll([
          'member_id', 'member', 'attendance_date',
          'origin_branch_id', 'visited_branch_id',
          'attendance_date_time', 'status'
        ]) &&
        attendanceId == request.resource.data.member_id + "_" + request.resource.data.attendance_date &&
        !exists(/databases/$(database)/documents/attendance/$(attendanceId)) &&
        (
          (sameBranch(request.resource.data.origin_branch_id) &&
            request.resource.data.status in ['PENDING','APPROVED'])
          ||
          (!sameBranch(request.resource.data.origin_branch_id) &&
            request.resource.data.status == 'PENDING')
        );

      allow update: if (
          // Admin / Approver can manage statuses
          (isAdminOrApprover() && sameBranch(resource.data.origin_branch_id) &&
            request.resource.data.status in ['PENDING','APPROVED','REJECTED','CANCELLED'])
          ||
          (isAuthenticated() && request.resource.data.status == 'CANCELLED' &&
            resource.data.created_by_user_id == request.auth.uid)
          ||
          // Reactivate a cancelled attendance (status 'PENDING') - Allow for cross-branch
          (isAuthenticated() &&
            resource.data.status == 'CANCELLED' &&
            request.resource.data.status == 'PENDING')
          ||
          // Reactivate to APPROVED (must be same branch and creator/admin)
          (isAuthenticated() &&
             resource.data.status == 'CANCELLED' &&
             request.resource.data.status == 'APPROVED' &&
             sameBranch(resource.data.origin_branch_id) &&
             (resource.data.created_by_user_id == request.auth.uid || isAdminOrApprover()))
        ) &&
        attendanceId == resource.id &&
        request.resource.data.member_id == resource.data.member_id &&
        request.resource.data.attendance_date == resource.data.attendance_date &&
        request.resource.data.origin_branch_id == resource.data.origin_branch_id;

      // Delete: Only Super Admins
      allow delete: if isSuperAdmin();
    }

    // Audit Logs Collection
    match /audit_logs/{logId} {
      // READ: Branch-based access control (Super Admin sees all)
      // Note: We will start saving 'branch_id' on audit logs to enable this
      allow read: if isSuperAdmin() || (resource.data.branch_id == getUserData().branch_id);
      
      // Append-only: Create allowed, no update/delete
      // Anyone performing an action can log it
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
  }
}
