rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    // Fetch user data from the 'users' collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check for specific roles
    function hasRole(role) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        getUserData().role == role;
    }

    function isSuperAdmin() {
      return hasRole('SUPER_ADMIN');
    }

    function isBranchAdmin() {
      return hasRole('BRANCH_ADMIN');
    }

    function isApprover() {
      return hasRole('APPROVER');
    }

    function isStaff() {
      return hasRole('STAFF');
    }

    function isAdminOrApprover() {
      return isSuperAdmin() || isBranchAdmin() || isApprover();
    }

    function isStaffOrAbove() {
      return isAuthenticated(); // Simplified: All authenticated users are essentially staff/active users
      // In a stricter system: return isSuperAdmin() || isBranchAdmin() || isApprover() || isStaff();
    }

    function sameBranch(value) {
      return isSuperAdmin() || (value != null && getUserData().branch_id != null && value.toString() == getUserData().branch_id.toString());
    }

    // --- Collections ---

    // Users Collection
    match /users/{userId} {
      // Users can read/write their own data
      // Super Admins can manage all users
      allow read: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin() || isBranchAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
    }

    // Members Collection
    // Members Collection
    match /members/{memberId} {
      // READ:
      // - Super Admin: Can read all
      // - Others: Can only read if the member belongs to their branch
      allow read: if isAuthenticated() && (
        isSuperAdmin() || 
        resource.data.origin_branch_id == getUserData().branch_id
      );
      
      // WRITE:
      // - Super Admin: Can write all
      // - Branch Admin/Approver: Can write if member belongs to their branch
      allow write: if isAdminOrApprover() && (
        isSuperAdmin() || 
        (
          // For Create/Update: New data must match user's branch
          request.resource.data.origin_branch_id == getUserData().branch_id &&
          // For Update: Existing data must also match (no taking over other branch members)
          (resource == null || resource.data.origin_branch_id == getUserData().branch_id)
        )
      ) &&
        // Schema Validation (Basic)
        (!request.resource.data.keys().hasAll(['status']) || request.resource.data.status in ['ACTIVE', 'INACTIVE']);
    }

    // Attendance Collection (one doc per member per calendar day)
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && sameBranch(resource.data.origin_branch_id);

      allow create: if isStaffOrAbove() &&
        request.resource.data.keys().hasAll([
          'member_id', 'member', 'attendance_date',
          'origin_branch_id', 'visited_branch_id',
          'attendance_date_time', 'status'
        ]) &&
        attendanceId == request.resource.data.member_id + "_" + request.resource.data.attendance_date &&
        !exists(/databases/$(database)/documents/attendance/$(attendanceId)) &&
        sameBranch(request.resource.data.origin_branch_id) &&
        (request.resource.data.status == 'PENDING' || isAdminOrApprover());

      allow update: if (
          // Admin / Approver can manage statuses
          (isAdminOrApprover() && sameBranch(resource.data.origin_branch_id) &&
            request.resource.data.status in ['PENDING','APPROVED','REJECTED','CANCELLED'])
          ||
          (isAuthenticated() && request.resource.data.status == 'CANCELLED' &&
            resource.data.created_by_user_id == request.auth.uid && sameBranch(resource.data.origin_branch_id))
          ||
          // Reactivate a cancelled attendance (creator or admin/approver, same branch)
          (isAuthenticated() &&
            resource.data.status == 'CANCELLED' &&
            request.resource.data.status in ['PENDING','APPROVED'] &&
            sameBranch(resource.data.origin_branch_id) &&
            (resource.data.created_by_user_id == request.auth.uid || isAdminOrApprover()))
        ) &&
        attendanceId == resource.id &&
        request.resource.data.member_id == resource.data.member_id &&
        request.resource.data.attendance_date == resource.data.attendance_date &&
        request.resource.data.origin_branch_id == resource.data.origin_branch_id;

      // Delete: Only Super Admins
      allow delete: if isSuperAdmin();
    }

    // Audit Logs Collection
    match /audit_logs/{logId} {
      // READ: Branch-based access control (Super Admin sees all)
      // Note: Audit logs don't have origin_branch_id by default, so this is optional
      // If you want to filter audit logs by branch, add origin_branch_id to audit log creation
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        // If audit logs have entity references, you could filter by those
        // For now, super admin only for full audit access
        isSuperAdmin()
      );
      
      // Append-only: Create allowed, no update/delete
      // Anyone performing an action can log it
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
  }
}
